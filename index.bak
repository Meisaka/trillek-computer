<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

    <title>Trillek Computer by trillek-team</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>Trillek Computer</h1>
        <h2>Trillek Virtual Computer specifications</h2>

        <section id="downloads">
          <a href="https://github.com/trillek-team/trillek-computer/zipball/master" class="btn">Download as .zip</a>
          <a href="https://github.com/trillek-team/trillek-computer/tarball/master" class="btn">Download as .tar.gz</a>
          <a href="https://github.com/trillek-team/trillek-computer" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1>
<a name="trillek-virtual-computer-specs" class="anchor" href="#trillek-virtual-computer-specs"><span class="octicon octicon-link"></span></a>Trillek Virtual Computer Specs</h1>

<p>Version 0.4h</p>

<p><strong>ADVICE</strong> : In this documents there some technical stuff that could looks hard
or complex to understand for not hardware guys.
Some of these stuff there is only to give natural limitations of what can do 
and can't do the computer. If your only interest is programing the computer, 
you should check the instruction set of a CPU and the specs of the devices to
understand how program the computer and use the devices at assembly or C 
programing level.</p>

<p><strong>NOTATION</strong> : Byte is a 8 bit value. Word is a 16 bit value and DWord is a 32 
bit value.</p>

<h2>
<a name="summary" class="anchor" href="#summary"><span class="octicon octicon-link"></span></a>SUMMARY</h2>

<ul>
<li>32 bit data bus, but allow transfers of 16 and 8 bit.</li>
<li>24 bit address space (0x000000-0xFFFFFF).</li>
<li>Little endian architecture.</li>
<li>32KiB ROM chip at address 0x100000-0x107FFF</li>
<li>Initial 128KiB RAM at address 0x000000- 0x01FFFF</li>
<li>RAM expandable with modules of 128KiB to a total of 1 MiB of RAM 
(0x000000-0x0FFFFF)</li>
<li>CPUs are connected by a CPU board (actually TR3200 and DCPU-16N) to the 
mother board. Only one CPU can be connected to the computer at same time 
(not multi-processor setups)</li>
<li>CPU Clock speed could be 1Mhz , 500 Khz, 200 Khz and 100Khz (actually we 
work with 100Khz, but we expect to allow higher speeds). CPU clock speed in KHz 
can be read at address 0x11E050 (I/O port 0xE050 on DCPU-16N)</li>
<li>Devices uses a fixed clock of 100Khz (thinking to change it to 50 KHz) if 
they need to do periodic or sync stuff.</li>
<li>Devices are <a href="http://en.wikipedia.org/wiki/Memory-mapped_I/O">memory mapped</a>.
So dcpu's <strong>HWI</strong> is replaced by writing/reading to addresses where the 
device is listening. <strong>HWN</strong> and <strong>HWQ</strong> is replaced by reading addresses.</li>
<li>Addresses used by devices are over 0x110000 to avoid address clashes with 
the RAM/ROM.</li>
<li>Addresses 0x110000 to 0x112000 are reserved to Devices Enumeration and 
Communication.</li>
<li>At address 0x11XX00, were <strong>XX</strong> is the device slot number (to a total 
of 32 -&gt; 0x20), there is mapped the <strong>Enumeration And Control registers</strong> of 
device <strong>XX</strong>, that consists : 
Device Type, Device SubType, Device ID, Device Vendor ID, CMD, A, B, C, 
D, E hardware registers. </li>
<li>Devices could do <strong>DMA</strong> operations at will, but ONLY one device could do 
that at same time, and can only transfer 4 bytes every Device Clock (like 
if the DMA operates in the falling clock flank and the CPU operated in the
rising clock flank.)</li>
<li>Usually the devices exposes his own ram and&amp;or uses commands. The only 
exception is the most basic graphics device that uses computer RAM as buffer.</li>
<li>The computer can be expanded to a total 32 devices, not counting integrated 
devices on motherboard. This can be archived by plugin the device boards in 
the expansion bus. Some devices will require a external module attached to 
the computer, like floppy drives, graphics cards, joysticks, weapons, etc...</li>
<li>Integrated devices on motherboard:

<ul>
<li>Programmable Interval Timer (<strong>PIT</strong>) aka <em>Clock</em> device.</li>
<li>Real Time Clock (<strong>RTC</strong>), that gives the date and time in game world 
when is polled (not have alarm).</li>
<li>Random Number Generator (<strong>RNG</strong>), that generates a 32 bit random number
every time that is polled (at implementation level, a simple call to 
rand_r)</li>
<li>Beeper or <em>buzzer</em> device (<strong>Beeper</strong>). Simply generates a squared wave 
sound at desired frequency.</li>
<li>256 bytes of NVRAM (Not Volatile RAM). Usefull to store basic configration 
used in boot time.</li>
<li>256 bytes reserved for CPU board HW registers from 0x11FF00 to 0x11FFFF</li>
</ul>
</li>
</ul><h2>
<a name="how-works" class="anchor" href="#how-works"><span class="octicon octicon-link"></span></a>HOW WORKS</h2>

<p><img src="./img/computer.png" alt="Computer Architecture Diagram" title="Diagram"></p>

<p>As can you see, the computer uses a 24 bit Address Bus and 32 bit Data bus. RAM
and ROM are directly attached to these buses, as any device in the computer
that is controllable by software. Also there is the integrated devices.</p>

<h3>
<a name="interrupts" class="anchor" href="#interrupts"><span class="octicon octicon-link"></span></a>Interrupts</h3>

<p>To avoid clashes with interrupt petitions, we daisy chain the interrupt signals
<em>INT</em> and <em>IACQ</em> . So when two devices try to generate a interrupt at same time
, the device more near to the CPU (with lowest slot number), have preference. 
The <strong>PIT</strong> and <strong>Keyboard controller</strong> devices can generate interrupts, so we 
put it between the expandable devices and the CPU having more preference that 
any expansion device. Plus the <strong>PIT</strong> have more preference as is more near to 
the CPU that the Keyboard Controller.</p>

<p><strong>NOTE FOR USERS</strong>: In other words, you only need to worry about the interrupt 
message in your <strong>Interrupt Service Routine</strong> (ISR). This stuff is to put some 
limitations to the computer and add some details at implementation of it.</p>

<p><strong>NOTE FOR IMPLEMENTATION</strong>: This means that when you need to "executes" the 
hardware devices, you only need to loop the device array in order and check if 
device <strong>x</strong> send a Interrupt. If it happens, allow it to send the message to 
the CPU, and just ignore the Interrupt petitions for the rest of the loop.</p>

<h3>
<a name="hardware-enumeration" class="anchor" href="#hardware-enumeration"><span class="octicon octicon-link"></span></a>Hardware Enumeration</h3>

<p>Devices maps 0x11XX00 address block, were XX is the slot were is plugged. 
In these address block that we call <strong>Enumeration And Control registers</strong>, there
 is a few registers :</p>

<ul>
<li>Present flag (Read byte): At offset 0,there is a byte that always read 0xFF 
if a device is plugged in these slot.</li>
<li>Device Type register (Read byte): At offset 1, there is a byte that gives 
information about the device type (see Device Type list section).</li>
<li>Device SubType register (Read byte): At offset 2, there is a byte that gives 
information about the device subtype (see Device Type list section).</li>
<li>Device ID register (Read byte) : At offset 3, there is a byte that gives the
Device ID. </li>
<li>Device Vendor ID register (Read dword) : At offset 4, there is dword that 
gives the Vendor/Builder ID of the device (see know Device Vendor list section). </li>
<li>CMD register (Write word) : At offset 8, there is a d that writing to it, 
sends a command to the device. The command list is dependent of the device,
and is showed in the device specs.</li>
<li>A, B, C, D, E registers (Read/Write word every one) : Begin at offset 10, 
there is five word registers that are used to send values with the commands 
and receive status/error or other stuff from the devices.</li>
</ul><p><img src="./img/DevConfigHeader.png" alt="Device Enumeration And Control Header" title="DevHeader"></p>

<p>To know how many devices are plugged to the computer, you only need to read the 
first byte of the 32 addresses and count one more for every byte being 0xFF.
The tuple {Device Vendor ID, Device ID} defines a unique device. This information 
can be used to allow the software know what device is plugged and how should 
use it.
Devices that have the same {Device Type ID, Device SubType ID} are expect that 
share some minimal compatibility. To archive this, should share a minimal list 
of commands with the same expected behavior.</p>

<p><strong>NOTE FOR USERS</strong>: This is nearly the same stuff that does the original 
Notch's DCPU-16, but being memory mapped instead of being special magic 
instructions. Each device have his own set registers. The device at slot 0 have
this registers at 0x110000, and his A register is at 0x11000A; device 8 have this 
registers at 0x110800, and his BuildID register is at 0x110804; etc...</p>

<h4>
<a name="device-types-and-subtypes-values" class="anchor" href="#device-types-and-subtypes-values"><span class="octicon octicon-link"></span></a>Device Types and SubTypes values</h4>

<p>Here is a list of Device Types. Each entry could contain a sublist of actually know subtypes.</p>

<ul>
<li>0x00 : Unclassified device</li>
<li>0x01 : Audio devices (Sound Cards)</li>
<li>0x02 : Communications device

<ul>
<li>0xFF : Serial Console</li>
</ul>
</li>
<li>0x03 : HID (Human Interface Device)<br><ul>
<li>0x01 : Western/Latin Keyboard</li>
</ul>
</li>
<li>0x04 : Expansion bus device</li>
<li>0x06 : Image/Video Input device</li>
<li>0x07 : Printer (2D and 3D) device</li>
<li>0x08 : Mass Storage device (Floppy drives, Microdrives, Hard disks, Tape 
recorders)

<ul>
<li>0x01 : Floppy drive</li>
</ul>
</li>
<li>0x09 : Network device</li>
<li>0x0A : Co-Processors</li>
<li>0x0E : Graphics Devices (Graphics card)

<ul>
<li>0x01 : TGA compatible</li>
</ul>
</li>
<li>0x0F : HoloGraphics Devices</li>
<li>0x10 : Ship Sensors (DRADIS, Air, Hull integrity, etc...)</li>
<li>0x11 : Power Management Systems (control of Generators)</li>
<li>0x12 : Hydraulic/Pneumatic Actuators (control of doors, air-locks, landing 
gears)</li>
<li>0x13 : Electric Engines (control of wheels and steering)</li>
<li>0x1A : Defensive Systems (control of shields)</li>
<li>0x1B : Offensive Systems (control of weapons)</li>
<li>0x1C : Sub-FTL Navigational and Engine Systems (control of thrusters and 
engines)</li>
<li>0x1D : FTL Navigational Systems (control of warp engines)</li>
<li>0xFF : Unassigned class</li>
</ul><h4>
<a name="know-vendor-values" class="anchor" href="#know-vendor-values"><span class="octicon octicon-link"></span></a>Know Vendor values</h4>

<ul>
<li>0x00000000 -&gt; Unknown builder (reserved value)</li>
<li>0x048BAD15 -&gt; RocoCorp.</li>
<li>0x1C6C8B36 -&gt; Nya Elektriska</li>
<li>0x1EB37E91 -&gt; Mackapar Media</li>
<li>0x21544948 -&gt; Harold Innovation Technologies (Harold I.T.)</li>
<li>0x494E5645 -&gt; Investronics</li>
<li>0xA87C900E -&gt; KaiComm</li>
</ul><h3>
<a name="pit-programmable-interval-timer" class="anchor" href="#pit-programmable-interval-timer"><span class="octicon octicon-link"></span></a>PIT (PROGRAMMABLE INTERVAL TIMER)</h3>

<p>The PIT consists in two 32 bit timers as can you find in any modern 
micro-controller. Allow to do time measurements and generate periodic 
interrupts for system clock and tasks switchers. Have the highest priority when
needs to signal a interrupt.</p>

<p><strong>NOTE FOR USERS</strong>: Could look a bit more hard that the Noth's DCPU-16 Timer 
device, but gives more freedom and control. Plus is more easy to 
understand and use that the IBM PC timer. Using the highest interrupt priority 
means that will be the first Interrupt to be attended by the CPU when 
simultaneous interrupts happens.</p>

<p><strong>NOTE FOR VM IMPLEMENTATION</strong>: Uses two vars per timer. One stores the Reload 
value and the other count downs every timer clock tick. The times generated are
in Virtual Computer time, so if you run the Virtual Computer at 200% speed, the
measured times should be the half.</p>

<h3>
<a name="rtc-real-time-clock" class="anchor" href="#rtc-real-time-clock"><span class="octicon octicon-link"></span></a>RTC (Real Time Clock)</h3>

<p>Is a basic device that gives the actual game time and date. Not have alarm, so 
is necessary doing a polling every 12 or 24 hours to keep a software clock in 
sync with game time. Gives time information in dd-mm-yyyy hh:mm:ss format (see specs)</p>

<h3>
<a name="rng-random-number-generator" class="anchor" href="#rng-random-number-generator"><span class="octicon octicon-link"></span></a>RNG (Random Number Generator)</h3>

<p>Is a basic device that writing to it, sets the RNG seed, and reading from it, 
gets a 32 bit random number. Simply reading a dword from 0x11E040 gets a 32 bit 
random number. Writing to the same address, setups the random seed. (see specs)</p>

<h3>
<a name="beeper" class="anchor" href="#beeper"><span class="octicon octicon-link"></span></a>Beeper</h3>

<p>Simple basic Beeper with similar functionality to the IBM PC speaker or 
ZX Spectrum beeper. It have less power as can't allow do PWM to generate basic
crude PCM sound, but it makes a lot more simple to use and understand.</p>

<p><strong>NOTE FOR VM IMPLEMENTATION</strong>: Try to use a Band-Limited Sound Synthesis lib 
to generate square wave sound, but a crude Fourier synthesis could do the trick.</p>

<h3>
<a name="nvram" class="anchor" href="#nvram"><span class="octicon octicon-link"></span></a>NVRAM</h3>

<p>The computer motherboard includes a small 256 bytes NVRAM powered by a litium battery.
This small not volatile RAM are mapped in 0x11F000 to 0x11F0FF, and can be used 
for boot configuration stuff.</p>

<h3>
<a name="devices-with-dma-direct-memory-access" class="anchor" href="#devices-with-dma-direct-memory-access"><span class="octicon octicon-link"></span></a>Devices with DMA (Direct Memory Access)</h3>

<p>DMA operations by the hardware devices are allowed, but only one DMA operation 
could be happening at same time at a rate of 4 byte for each device clock. To 
avoid that two or more devices try to do a DMA operation, there is a BUSY BUS 
signal. DMA operations happens in the opposite flank that the CPU clock, so 
don't interfere and not need contention hardware.</p>

<p><strong>NOTE FOR VM IMPLEMENTATION</strong>: By practical reasons, this will translated in a
flag in the Virtual Computer to indicate if a device will being doing DMA, as 
can't be two devices doing a DMA at same time. </p>

<h2>
<a name="documents" class="anchor" href="#documents"><span class="octicon octicon-link"></span></a>DOCUMENTS</h2>

<h3>
<a name="cpus" class="anchor" href="#cpus"><span class="octicon octicon-link"></span></a>CPUs</h3>

<ul>
<li><a href="./cpu/TR3200.md">TR3200 CPU</a></li>
<li><a href="./cpu/DCPU-16N.txt">DCPU-16N CPU</a></li>
</ul><h3>
<a name="embed-devices" class="anchor" href="#embed-devices"><span class="octicon octicon-link"></span></a>Embed Devices</h3>

<ul>
<li>
<a href="./embed/Timers.md">Programmable Interval Timer</a> (aka Timer or Clock)</li>
<li><a href="./embed/RTC.md">RTC</a></li>
<li><a href="./embed/RNG.md">RNG</a></li>
<li><a href="./embed/Beeper.md">Beeper</a></li>
</ul><h3>
<a name="devices" class="anchor" href="#devices"><span class="octicon octicon-link"></span></a>Devices</h3>

<ul>
<li><a href="./devices/Keyboard.md">Generic Keyboard</a></li>
<li>
<a href="./devices/TGA.md">Text Generator Adapter</a> (TGA)</li>
<li>
<a href="./devices/CDA.md">Color Display Adapter</a> (CDA)</li>
<li>
<a href="./devices/floppy_drive.md">5.25" Floppy Drive</a> (M5FDD)</li>
<li><a href="./devices/SerialConsole.md.md">Debug Serial Console</a></li>
</ul><h3>
<a name="misc" class="anchor" href="#misc"><span class="octicon octicon-link"></span></a>MISC</h3>

<ul>
<li><a href="./img/computer.png">Computer Architecture Diagram</a></li>
<li><a href="./img/memory_map.png">Memory Model</a></li>
<li><a href="./cpu/calling_convention.md">Calling Conventions</a></li>
</ul><h2>
<a name="advice" class="anchor" href="#advice"><span class="octicon octicon-link"></span></a>ADVICE</h2>

<p>Trillek MS2.5, is not using the latests specs. Please use the latest version 
from trillek-vcomputer-module.</p>
      </section>
    </div>

    
  </body>
</html>